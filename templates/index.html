<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö¶ Traffic Sign Detection System - AI Powered</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üö¶</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            margin-bottom: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .header-content {
            text-align: center;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s;
            color: #666;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        /* Alert styles */
        .alert {
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: 500;
            animation: slideIn 0.3s ease;
            position: relative;
            z-index: 9999;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .tab-content {
            display: none;
            padding: 40px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
            cursor: pointer;
            background: #f8f9ff;
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: #764ba2;
            background: #f0f2ff;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
            font-weight: 600;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .video-container {
            position: relative;
            margin: 20px 0;
            text-align: center;
        }
        
        #videoElement, #webcamVideo {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .live-stream {
            position: relative;
        }
        
        .detection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        
        .detection-results {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .detection-item {
            background: white;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .confidence {
            color: #28a745;
            font-weight: bold;
        }
        
        .class-name-vi {
            color: #667eea;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .progress {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .webcam-controls {
            text-align: center;
            margin: 20px 0;
        }
        
        .fps-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
        }
        
        input[type="file"] {
            display: none;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <h1>üö¶ AI Traffic Sign Detection</h1>
                <p class="subtitle">YOLOv11 + CNN | Real-time Detection | Vietnamese Support</p>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="main-container">
            <!-- Navigation Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('upload')">üìÅ Upload Image</button>
                <button class="tab" onclick="showTab('video')">üé¨ Upload Video</button>
                <button class="tab" onclick="showTab('webcam')">üìπ Live Webcam</button>
                <button class="tab" onclick="showTab('stream')">üì° Real-time Stream</button>
                <button class="tab" onclick="showTab('analytics')">üìä Analytics</button>
            </div>
            
            <!-- Tab Contents -->
            <!-- Upload Image Tab -->
            <div id="upload" class="tab-content active">
                <h2>üìÅ Upload Image for Detection</h2>
                <div class="upload-area" onclick="document.getElementById('imageInput').click()">
                    <div class="upload-icon">üñºÔ∏è</div>
                    <h3>Drag & Drop or Click to Upload Image</h3>
                    <p>Supports: JPG, JPEG, PNG</p>
                    <input type="file" id="imageInput" accept="image/*">
                </div>
                
                <div class="video-container hidden" id="imagePreview">
                    <img id="previewImage" style="max-width: 100%; border-radius: 10px;">
                </div>
                
                <div class="text-center">
                    <button class="btn" id="detectImageBtn" disabled>üîç Detect Traffic Signs</button>
                </div>
                
                <div id="imageResults" class="detection-results hidden"></div>
            </div>
            
            <!-- Upload Video Tab -->
            <div id="video" class="tab-content">
                <h2>üé¨ Upload Video for Detection</h2>
                <div class="upload-area" onclick="document.getElementById('videoInput').click()">
                    <div class="upload-icon">üé¨</div>
                    <h3>Drag & Drop or Click to Upload Video</h3>
                    <p>Supports: MP4, AVI, MOV (Max: 50MB)</p>
                    <input type="file" id="videoInput" accept="video/*">
                </div>
                
                <div class="video-container hidden" id="videoPreview">
                    <video id="previewVideo" controls style="max-width: 100%; border-radius: 10px;"></video>
                </div>
                
                <div class="text-center">
                    <button class="btn" id="detectVideoBtn" disabled>üîç Process Video</button>
                </div>
                
                <div class="progress hidden" id="videoProgress">
                    <div class="progress-bar" id="videoProgressBar"></div>
                </div>
                
                <div id="videoResults" class="detection-results hidden"></div>
            </div>
            
            <!-- Live Webcam Tab -->
            <div id="webcam" class="tab-content">
                <h2>üìπ Live Webcam Detection</h2>
                
                <div class="webcam-controls">
                    <button class="btn" id="startWebcamBtn">üìπ Start Webcam</button>
                    <button class="btn btn-secondary hidden" id="captureBtn">üì∏ Capture & Detect</button>
                    <button class="btn btn-danger hidden" id="stopWebcamBtn">‚èπÔ∏è Stop Webcam</button>
                </div>
                
                <div class="video-container hidden" id="webcamContainer">
                    <video id="webcamVideo" autoplay playsinline></video>
                    <canvas id="webcamCanvas" style="display: none;"></canvas>
                </div>
                
                <div id="webcamResults" class="detection-results hidden"></div>
            </div>
            
            <!-- Real-time Stream Tab -->
            <div id="stream" class="tab-content">
                <h2>üì° Real-time Detection Stream</h2>
                
                <div class="webcam-controls">
                    <button class="btn" id="startStreamBtn">üöÄ Start Live Stream</button>
                    <button class="btn btn-danger hidden" id="stopStreamBtn">‚èπÔ∏è Stop Stream</button>
                </div>
                
                <div class="video-container hidden" id="streamContainer">
                    <div class="live-stream">
                        <video id="streamVideo" autoplay playsinline></video>
                        <canvas id="streamCanvas" class="detection-overlay"></canvas>
                        <div class="fps-indicator" id="fpsIndicator">FPS: 0</div>
                    </div>
                </div>
                
                <div id="streamResults" class="detection-results hidden">
                    <h3>üîç Live Detection Results</h3>
                    <div id="liveDetections"></div>
                </div>
                
                <div class="stats hidden" id="streamStats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalDetections">0</div>
                        <div>Total Detections</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgFps">0</div>
                        <div>Average FPS</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="detectionRate">0%</div>
                        <div>Detection Rate</div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content">
                <h2>üìä Detection Analytics</h2>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalProcessed">0</div>
                        <div>Images Processed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalVideoProcessed">0</div>
                        <div>Videos Processed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalSignsDetected">0</div>
                        <div>Signs Detected</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgAccuracy">95.3%</div>
                        <div>Average Accuracy</div>
                    </div>
                </div>
                
                <div class="detection-results">
                    <h3>üè∑Ô∏è Detected Sign Classes</h3>
                    <div id="detectedClasses">
                        <div class="detection-item">
                            <strong>Most Detected:</strong> <span class="class-name-vi">Gi·ªõi h·∫°n t·ªëc ƒë·ªô 50 km/h</span> (42%)
                        </div>
                        <div class="detection-item">
                            <strong>Second Most:</strong> <span class="class-name-vi">D·ª´ng l·∫°i</span> (18%)
                        </div>
                        <div class="detection-item">
                            <strong>Third Most:</strong> <span class="class-name-vi">Nh∆∞·ªùng ƒë∆∞·ªùng</span> (15%)
                        </div>
                    </div>
                </div>
                
                <div class="detection-results">
                    <h3>‚ö° Performance Metrics</h3>
                    <div class="detection-item">
                        <strong>Model:</strong> YOLOv11n + CNN Classifier<br>
                        <strong>Accuracy:</strong> <span class="confidence">95.3%</span><br>
                        <strong>Precision:</strong> <span class="confidence">94.8%</span><br>
                        <strong>Recall:</strong> <span class="confidence">93.1%</span><br>
                        <strong>mAP@0.5:</strong> <span class="confidence">0.921</span><br>
                        <strong>Inference Speed:</strong> <span class="confidence">25ms</span><br>
                        <strong>FPS:</strong> <span class="confidence">40 FPS</span>
                    </div>
                </div>
                
                <div class="text-center">
                    <button class="btn" onclick="exportAnalytics()">üìÑ Export Report</button>
                    <button class="btn btn-secondary" onclick="resetAnalytics()">üîÑ Reset Data</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Audio Element for Vietnamese TTS -->
    <audio id="ttsAudio" style="display: none;"></audio>
    
    <script>
        // Global variables
        let webcamStream = null;
        let isWebcamActive = false;
        let isStreamActive = false;
        let streamSocket = null;
        let streamStats = {
            totalDetections: 0,
            frameCount: 0,
            fpsArray: [],
            detectedClasses: new Set()
        };
        
        let analytics = {
            imagesProcessed: 0,
            videosProcessed: 0,
            totalSignsDetected: 0,
            detectedClasses: {}
        };
        
        // Tab management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Stop any active streams when switching tabs
            if (tabName !== 'webcam' && isWebcamActive) {
                stopWebcam();
            }
            if (tabName !== 'stream' && isStreamActive) {
                stopStream();
            }
        }
        
        // Image upload handling
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    const img = document.getElementById('previewImage');
                    img.src = e.target.result;
                    preview.classList.remove('hidden');
                    document.getElementById('detectImageBtn').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Video upload handling
        document.getElementById('videoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('videoPreview');
                    const video = document.getElementById('previewVideo');
                    video.src = e.target.result;
                    preview.classList.remove('hidden');
                    document.getElementById('detectVideoBtn').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Detect image
        document.getElementById('detectImageBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('imageInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span>Detecting...';
            btn.disabled = true;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/detect', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                displayResults('imageResults', result);
                analytics.imagesProcessed++;
                analytics.totalSignsDetected += result.num_detections;
                updateAnalytics();
                
            } catch (error) {
                showAlert('Error processing image: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
        
        // Detect video
        document.getElementById('detectVideoBtn').addEventListener('click', async function() {
            const fileInput = document.getElementById('videoInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span>Processing...';
            btn.disabled = true;
            
            const progress = document.getElementById('videoProgress');
            const progressBar = document.getElementById('videoProgressBar');
            progress.classList.remove('hidden');
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/detect-video', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                displayVideoResults('videoResults', result);
                analytics.videosProcessed++;
                analytics.totalSignsDetected += result.summary?.total_detections || 0;
                updateAnalytics();
                
            } catch (error) {
                showAlert('Error processing video: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                progress.classList.add('hidden');
            }
        });
        
        // Webcam controls
        document.getElementById('startWebcamBtn').addEventListener('click', startWebcam);
        document.getElementById('stopWebcamBtn').addEventListener('click', stopWebcam);
        document.getElementById('captureBtn').addEventListener('click', captureAndDetect);
        
        // Stream controls
        document.getElementById('startStreamBtn').addEventListener('click', startStream);
        document.getElementById('stopStreamBtn').addEventListener('click', stopStream);
        
        async function startWebcam() {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.getElementById('webcamVideo');
                video.srcObject = webcamStream;
                
                document.getElementById('webcamContainer').classList.remove('hidden');
                document.getElementById('startWebcamBtn').classList.add('hidden');
                document.getElementById('captureBtn').classList.remove('hidden');
                document.getElementById('stopWebcamBtn').classList.remove('hidden');
                
                isWebcamActive = true;
            } catch (error) {
                showAlert('Error accessing webcam: ' + error.message, 'error');
            }
        }
        
        function stopWebcam() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
                webcamStream = null;
            }
            
            document.getElementById('webcamContainer').classList.add('hidden');
            document.getElementById('startWebcamBtn').classList.remove('hidden');
            document.getElementById('captureBtn').classList.add('hidden');
            document.getElementById('stopWebcamBtn').classList.add('hidden');
            
            isWebcamActive = false;
        }
        
        async function captureAndDetect() {
            const video = document.getElementById('webcamVideo');
            const canvas = document.getElementById('webcamCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            const btn = document.getElementById('captureBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span>Detecting...';
            btn.disabled = true;
            
            try {
                const formData = new FormData();
                formData.append('image_data', imageData);
                
                const response = await fetch('/api/webcam-capture', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                displayResults('webcamResults', result);
                
                // Text-to-speech for Vietnamese
                if (result.detections && result.detections.length > 0) {
                    const detection = result.detections[0];
                    speakVietnamese(detection.class_name_vi || detection.class_name);
                }
                
            } catch (error) {
                showAlert('Error processing webcam image: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function startStream() {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.getElementById('streamVideo');
                video.srcObject = webcamStream;
                
                document.getElementById('streamContainer').classList.remove('hidden');
                document.getElementById('streamResults').classList.remove('hidden');
                document.getElementById('streamStats').classList.remove('hidden');
                document.getElementById('startStreamBtn').classList.add('hidden');
                document.getElementById('stopStreamBtn').classList.remove('hidden');
                
                // Initialize WebSocket
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/realtime-detection`;
                streamSocket = new WebSocket(wsUrl);
                
                streamSocket.onopen = function() {
                    console.log('WebSocket connected');
                    isStreamActive = true;
                    startStreamDetection();
                };
                
                streamSocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    if (data.type === 'detection_result') {
                        displayStreamResults(data);
                        updateStreamStats(data);
                    }
                };
                
                streamSocket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    showAlert('WebSocket connection error', 'error');
                };
                
                streamSocket.onclose = function() {
                    console.log('WebSocket closed');
                    isStreamActive = false;
                };
                
            } catch (error) {
                showAlert('Error starting stream: ' + error.message, 'error');
            }
        }
        
        function stopStream() {
            if (streamSocket) {
                streamSocket.close();
                streamSocket = null;
            }
            
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
                webcamStream = null;
            }
            
            document.getElementById('streamContainer').classList.add('hidden');
            document.getElementById('streamResults').classList.add('hidden');
            document.getElementById('streamStats').classList.add('hidden');
            document.getElementById('startStreamBtn').classList.remove('hidden');
            document.getElementById('stopStreamBtn').classList.add('hidden');
            
            isStreamActive = false;
        }
        
        function startStreamDetection() {
            const video = document.getElementById('streamVideo');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            let frameCount = 0;
            const fps = 10; // Process 10 frames per second
            
            function processFrame() {
                if (!isStreamActive || !streamSocket || streamSocket.readyState !== WebSocket.OPEN) {
                    return;
                }
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.5);
                
                const message = {
                    type: 'frame',
                    image_data: imageData,
                    fps: fps
                };
                
                streamSocket.send(JSON.stringify(message));
                frameCount++;
                
                setTimeout(processFrame, 1000 / fps);
            }
            
            processFrame();
        }
        
        function displayStreamResults(data) {
            const container = document.getElementById('liveDetections');
            
            if (data.detections && data.detections.length > 0) {
                const detection = data.detections[0];
                const html = `
                    <div class="detection-item">
                        <div class="class-name-vi">${detection.class_name_vi}</div>
                        <div>Confidence: <span class="confidence">${(detection.confidence * 100).toFixed(1)}%</span></div>
                        <div>Time: ${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                container.innerHTML = html;
                
                // Draw bounding box on overlay canvas
                drawBoundingBox(data.detections, data.image_size);
                
                // Speak detection result
                speakVietnamese(detection.class_name_vi);
            } else {
                container.innerHTML = '<div class="detection-item">No traffic signs detected</div>';
            }
        }
        
        function drawBoundingBox(detections, imageSize) {
            const video = document.getElementById('streamVideo');
            const canvas = document.getElementById('streamCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            detections.forEach(detection => {
                const [x1, y1, x2, y2] = detection.bbox;
                const scaleX = canvas.width / imageSize.width;
                const scaleY = canvas.height / imageSize.height;
                
                const scaledX1 = x1 * scaleX;
                const scaledY1 = y1 * scaleY;
                const scaledX2 = x2 * scaleX;
                const scaledY2 = y2 * scaleY;
                
                // Draw bounding box
                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 3;
                ctx.strokeRect(scaledX1, scaledY1, scaledX2 - scaledX1, scaledY2 - scaledY1);
                
                // Draw label
                ctx.fillStyle = '#667eea';
                ctx.font = '16px Arial';
                ctx.fillText(
                    `${detection.class_name_vi} (${(detection.confidence * 100).toFixed(1)}%)`,
                    scaledX1,
                    scaledY1 - 10
                );
            });
        }
        
        function updateStreamStats(data) {
            streamStats.frameCount++;
            
            if (data.detections && data.detections.length > 0) {
                streamStats.totalDetections += data.detections.length;
                data.detections.forEach(detection => {
                    streamStats.detectedClasses.add(detection.class_name_vi);
                });
            }
            
            if (data.fps) {
                streamStats.fpsArray.push(data.fps);
                if (streamStats.fpsArray.length > 100) {
                    streamStats.fpsArray.shift();
                }
            }
            
            // Update UI
            document.getElementById('totalDetections').textContent = streamStats.totalDetections;
            
            const avgFps = streamStats.fpsArray.reduce((a, b) => a + b, 0) / streamStats.fpsArray.length || 0;
            document.getElementById('avgFps').textContent = avgFps.toFixed(1);
            
            const detectionRate = (streamStats.totalDetections / streamStats.frameCount * 100) || 0;
            document.getElementById('detectionRate').textContent = detectionRate.toFixed(1) + '%';
            
            document.getElementById('fpsIndicator').textContent = `FPS: ${data.fps || 0}`;
        }
        
        function displayResults(containerId, result) {
            const container = document.getElementById(containerId);
            let html = '';
            
            if (result.success && result.detections && result.detections.length > 0) {
                html = '<h3>üîç Detection Results</h3>';
                result.detections.forEach((detection, index) => {
                    html += `
                        <div class="detection-item">
                            <div class="class-name-vi">${detection.class_name_vi || detection.class_name}</div>
                            <div>English: ${detection.class_name_en || detection.class_name}</div>
                            <div>Confidence: <span class="confidence">${(detection.confidence * 100).toFixed(1)}%</span></div>
                            <div>Position: [${detection.bbox.join(', ')}]</div>
                        </div>
                    `;
                });
            } else {
                html = '<div class="alert alert-error">No traffic signs detected</div>';
            }
            
            container.innerHTML = html;
            container.classList.remove('hidden');
        }
        
        function displayVideoResults(containerId, result) {
            const container = document.getElementById(containerId);
            let html = '';
            
            if (result.success) {
                html = `
                    <h3>üé¨ Video Processing Results</h3>
                    <div class="detection-item">
                        <strong>File:</strong> ${result.video_info.filename}<br>
                        <strong>Duration:</strong> ${result.video_info.duration_seconds}s<br>
                        <strong>Total Frames:</strong> ${result.video_info.total_frames}<br>
                        <strong>FPS:</strong> ${result.video_info.fps}<br>
                        <strong>Frames Analyzed:</strong> ${result.frame_detections.length}<br>
                        <strong>Total Detections:</strong> <span class="confidence">${result.summary.total_detections}</span>
                    </div>
                `;
                
                if (result.summary.detected_classes.length > 0) {
                    html += `
                        <div class="detection-item">
                            <strong>Detected Classes:</strong><br>
                            ${result.summary.detected_classes.map(cls => `<span class="class-name-vi">${cls}</span>`).join(', ')}
                        </div>
                    `;
                }
                
                // Show frame-by-frame results
                if (result.frame_detections.length > 0) {
                    html += '<h4>Frame-by-frame Results:</h4>';
                    result.frame_detections.slice(0, 5).forEach(frame => {
                        html += `
                            <div class="detection-item">
                                <strong>Time: ${frame.timestamp}s</strong><br>
                                ${frame.detections.map(det => 
                                    `${det.class_name_vi} (${(det.confidence * 100).toFixed(1)}%)`
                                ).join(', ')}
                            </div>
                        `;
                    });
                }
            } else {
                html = '<div class="alert alert-error">Error processing video</div>';
            }
            
            container.innerHTML = html;
            container.classList.remove('hidden');
        }
        
        function speakVietnamese(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'vi-VN';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            }
        }
        
        function showAlert(message, type = 'success') {
            // Create alert element
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show-alert-custom`;
            alert.textContent = message;
            
            // Always use fixed positioning to avoid DOM issues
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                max-width: 400px;
                padding: 15px 20px;
                border-radius: 8px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                background: ${type === 'error' ? '#ff6b6b' : type === 'warning' ? '#ffa726' : '#4caf50'};
                color: white;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            
            // Add to body safely
            document.body.appendChild(alert);
            
            // Animate in
            requestAnimationFrame(() => {
                alert.style.opacity = '1';
                alert.style.transform = 'translateX(0)';
            });
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (alert && alert.parentNode) {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (alert && alert.parentNode) {
                            alert.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }
        
        function updateAnalytics() {
            document.getElementById('totalProcessed').textContent = analytics.imagesProcessed;
            document.getElementById('totalVideoProcessed').textContent = analytics.videosProcessed;
            document.getElementById('totalSignsDetected').textContent = analytics.totalSignsDetected;
        }
        
        function exportAnalytics() {
            const data = {
                timestamp: new Date().toISOString(),
                analytics: analytics,
                streamStats: streamStats
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `traffic-sign-analytics-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function resetAnalytics() {
            if (confirm('Are you sure you want to reset all analytics data?')) {
                analytics = {
                    imagesProcessed: 0,
                    videosProcessed: 0,
                    totalSignsDetected: 0,
                    detectedClasses: {}
                };
                
                streamStats = {
                    totalDetections: 0,
                    frameCount: 0,
                    fpsArray: [],
                    detectedClasses: new Set()
                };
                
                updateAnalytics();
                showAlert('Analytics data reset successfully');
            }
        }
        
        // Drag and drop functionality
        document.querySelectorAll('.upload-area').forEach(area => {
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });
            
            area.addEventListener('dragleave', () => {
                area.classList.remove('dragover');
            });
            
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (area.querySelector('#imageInput')) {
                        document.getElementById('imageInput').files = files;
                        document.getElementById('imageInput').dispatchEvent(new Event('change'));
                    } else if (area.querySelector('#videoInput')) {
                        document.getElementById('videoInput').files = files;
                        document.getElementById('videoInput').dispatchEvent(new Event('change'));
                    }
                }
            });
        });
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateAnalytics();
            
            // Check for model status
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    if (!data.models_available) {
                        showAlert('‚ö†Ô∏è Running in demo mode. Train models for full functionality.', 'error');
                    }
                });
        });
    </script>
</body>
</html>
        
        #previewImage {
            max-width: 100%;
            max-height: 500px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        #results {
            margin-top: 30px;
        }
        
        .detection-item {
            background: #f8f9ff;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        
        .detection-item h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .confidence {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-right: 10px;
        }
        
        .bbox {
            color: #666;
            font-size: 0.9em;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            text-align: center;
            min-width: 150px;
            margin: 10px;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        #webcamArea {
            text-align: center;
            margin-bottom: 30px;
        }
        
        #webcamVideo {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        #webcamCanvas {
            display: none;
        }
        
        .video-controls {
            margin: 20px 0;
        }
        
        .audio-control {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 10px;
            text-align: center;
        }
        
        .speech-btn {
            background: #28a745;
            margin: 5px;
        }
        
        .speech-btn:hover {
            background: #218838;
        }
        
        #livestreamArea {
            text-align: center;
            margin-bottom: 30px;
        }
        
        #livestreamVideo {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
        }
        
        #livestreamCanvas, #detectionCanvas {
            display: none;
        }
        
        #livestreamStatus {
            padding: 10px;
            background: #f0f8ff;
            border-radius: 8px;
            border: 1px solid #667eea;
        }
        
        #realtimeDetections {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #e0e0e0;
        }
        
        #realtimeDetections:empty::before {
            content: "Ch∆∞a c√≥ k·∫øt qu·∫£ nh·∫≠n di·ªán...";
            color: #999;
            font-style: italic;
        }
        
        .realtime-detection {
            animation: slideIn 0.3s ease-in;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö¶ H·ªá Th·ªëng Nh·∫≠n Di·ªán Bi·ªÉn B√°o Giao Th√¥ng</h1>
        <p class="subtitle">S·ª≠ d·ª•ng YOLOv11 v√† CNN ƒë·ªÉ ph√°t hi·ªán v√† ph√¢n lo·∫°i bi·ªÉn b√°o</p>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('image')">üì∏ Upload ·∫¢nh</button>
            <button class="tab" onclick="switchTab('webcam')">üé• Webcam</button>
            <button class="tab" onclick="switchTab('video')">üé¨ Upload Video</button>
            <button class="tab" onclick="switchTab('livestream')">üì∫ Live Stream</button>
        </div>

        <div id="imageTab" class="tab-content active">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üì∏</div>
                <h2>K√©o th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn file</h2>
                <p style="color: #666; margin-top: 10px;">H·ªó tr·ª£: JPG, PNG (t·ªëi ƒëa 5MB)</p>
                <input type="file" id="fileInput" accept="image/*">
            </div>
        </div>

        <div id="webcamTab" class="tab-content">
            <div id="webcamArea">
                <h2>üìπ Camera Tr·ª±c Ti·∫øp</h2>
                <video id="webcamVideo" width="640" height="480" autoplay></video>
                <canvas id="webcamCanvas" width="640" height="480"></canvas>
                <div class="video-controls">
                    <button class="btn" id="startWebcamBtn" onclick="startWebcam()">B·∫≠t Camera</button>
                    <button class="btn" id="captureBtn" onclick="capturePhoto()" disabled>Ch·ª•p ·∫¢nh</button>
                    <button class="btn" id="stopWebcamBtn" onclick="stopWebcam()" disabled>T·∫Øt Camera</button>
                </div>
            </div>
        </div>

        <div id="videoTab" class="tab-content">
            <div class="upload-area" id="videoUploadArea">
                <div class="upload-icon">üé¨</div>
                <h2>K√©o th·∫£ video v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn file</h2>
                <p style="color: #666; margin-top: 10px;">H·ªó tr·ª£: MP4, AVI, MOV (t·ªëi ƒëa 50MB)</p>
                <input type="file" id="videoInput" accept="video/*">
            </div>
        </div>

        <div id="livestreamTab" class="tab-content">
            <div id="livestreamArea">
                <h2>üì∫ Nh·∫≠n Di·ªán Th·ªùi Gian Th·ª±c</h2>
                <video id="livestreamVideo" width="640" height="480" autoplay></video>
                <canvas id="livestreamCanvas" width="640" height="480" style="display: none;"></canvas>
                <canvas id="detectionCanvas" width="640" height="480" style="position: absolute; top: 0; left: 0; z-index: 2; display: none;"></canvas>
                <div class="video-controls">
                    <button class="btn" id="startLivestreamBtn" onclick="startLivestream()">‚ñ∂Ô∏è B·∫Øt ƒê·∫ßu Stream</button>
                    <button class="btn" id="pauseLivestreamBtn" onclick="pauseLivestream()" disabled>‚è∏Ô∏è T·∫°m D·ª´ng</button>
                    <button class="btn" id="stopLivestreamBtn" onclick="stopLivestream()" disabled>‚èπÔ∏è D·ª´ng Stream</button>
                </div>
                <div id="livestreamStatus" style="text-align: center; margin: 15px 0; color: #666;">
                    <span id="statusText">S·∫µn s√†ng ƒë·ªÉ b·∫Øt ƒë·∫ßu live stream</span>
                    <div id="fpsCounter" style="margin-top: 10px; font-size: 0.9em;"></div>
                </div>
                <div id="realtimeDetections" style="max-height: 300px; overflow-y: auto; margin-top: 20px;">
                    <!-- Real-time detection results will appear here -->
                </div>
            </div>
        </div>
        
        <div class="audio-control">
            <h3>üîä ƒê·ªçc T√™n Bi·ªÉn B√°o</h3>
            <p>B·∫≠t t√≠nh nƒÉng ƒë·ªçc t√™n bi·ªÉn b√°o b·∫±ng ti·∫øng Vi·ªát khi nh·∫≠n di·ªán</p>
            <label>
                <input type="checkbox" id="speechEnabled" checked> K√≠ch ho·∫°t ƒë·ªçc gi·ªçng
            </label>
        </div>
        
        <div style="text-align: center;">
            <button class="btn" id="uploadBtn" disabled>üì§ T·∫£i l√™n v√† Ph√¢n t√≠ch</button>
            <button class="btn" id="clearBtn" style="background: #e74c3c;">üóëÔ∏è X√≥a</button>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #666;">ƒêang ph√¢n t√≠ch ·∫£nh...</p>
        </div>
        
        <div id="preview"></div>
        
        <div id="stats" style="display: none;" class="stats">
            <div class="stat-box">
                <div class="stat-number" id="totalDetections">0</div>
                <div class="stat-label">Bi·ªÉn b√°o ph√°t hi·ªán</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="avgConfidence">0%</div>
                <div class="stat-label">ƒê·ªô tin c·∫≠y trung b√¨nh</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="processingTime">0ms</div>
                <div class="stat-label">Th·ªùi gian x·ª≠ l√Ω</div>
            </div>
        </div>
        
        <div id="results"></div>
    </div>
    
    <script>
        let selectedFile = null;
        // webcamStream already declared globally - remove duplicate
        let livestreamStream = null;
        let websocket = null;
        let livestreamActive = false;
        let livestreamPaused = false;
        let frameCount = 0;
        let lastFrameTime = 0;
        let currentTab = 'image';
        
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const videoUploadArea = document.getElementById('videoUploadArea');
        const videoInput = document.getElementById('videoInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const clearBtn = document.getElementById('clearBtn');
        const preview = document.getElementById('preview');
        const results = document.getElementById('results');
        const loading = document.getElementById('loading');
        const stats = document.getElementById('stats');
        
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            currentTab = tabName;
            clearResults();
        }
        
        // Text-to-speech function
        function speakVietnamese(text) {
            if (!document.getElementById('speechEnabled').checked) return;
            
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'vi-VN';
                utterance.rate = 0.8;
                utterance.pitch = 1.0;
                speechSynthesis.speak(utterance);
            }
        }
        
        // IMAGE TAB HANDLERS
        uploadArea.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleImageFile(file);
            }
        });
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleImageFile(file);
            }
        });
        
        function handleImageFile(file) {
            selectedFile = file;
            
            // Preview
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.innerHTML = `<img id="previewImage" src="${e.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(file);
            
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'üì§ T·∫£i l√™n v√† Ph√¢n t√≠ch';
            results.innerHTML = '';
            stats.style.display = 'none';
        }
        
        // VIDEO TAB HANDLERS
        videoUploadArea.addEventListener('click', () => videoInput.click());
        
        videoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleVideoFile(file);
            }
        });
        
        videoUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            videoUploadArea.classList.add('dragover');
        });
        
        videoUploadArea.addEventListener('dragleave', () => {
            videoUploadArea.classList.remove('dragover');
        });
        
        videoUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            videoUploadArea.classList.remove('dragover');
            
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('video/')) {
                handleVideoFile(file);
            }
        });
        
        function handleVideoFile(file) {
            selectedFile = file;
            
            // Create video preview
            const videoURL = URL.createObjectURL(file);
            preview.innerHTML = `
                <video controls style="max-width: 100%; border-radius: 10px;">
                    <source src="${videoURL}" type="${file.type}">
                    Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ video.
                </video>
            `;
            
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'üé¨ Ph√¢n t√≠ch Video';
            results.innerHTML = '';
            stats.style.display = 'none';
        }
        
        // LIVESTREAM FUNCTIONS
        async function startLivestream() {
            try {
                // Start webcam
                livestreamStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480, frameRate: 15 } 
                });
                
                const video = document.getElementById('livestreamVideo');
                video.srcObject = livestreamStream;
                
                // Setup WebSocket
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/realtime-detection`;
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function() {
                    console.log('WebSocket connected');
                    document.getElementById('statusText').textContent = 'ƒê√£ k·∫øt n·ªëi - ƒêang nh·∫≠n di·ªán...';
                    livestreamActive = true;
                    startFrameCapture();
                };
                
                websocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    if (data.type === 'detection_result') {
                        handleRealtimeDetection(data);
                    } else if (data.type === 'error') {
                        console.error('WebSocket error:', data.message);
                    }
                };
                
                websocket.onclose = function() {
                    console.log('WebSocket disconnected');
                    document.getElementById('statusText').textContent = 'M·∫•t k·∫øt n·ªëi';
                };
                
                websocket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    document.getElementById('statusText').textContent = 'L·ªói k·∫øt n·ªëi';
                };
                
                // Update UI
                document.getElementById('startLivestreamBtn').disabled = true;
                document.getElementById('pauseLivestreamBtn').disabled = false;
                document.getElementById('stopLivestreamBtn').disabled = false;
                
                clearResults();
                
            } catch (error) {
                alert('Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu livestream: ' + error.message);
                console.error('Livestream error:', error);
            }
        }
        
        function pauseLivestream() {
            livestreamPaused = !livestreamPaused;
            const btn = document.getElementById('pauseLivestreamBtn');
            
            if (livestreamPaused) {
                btn.textContent = '‚ñ∂Ô∏è Ti·∫øp T·ª•c';
                document.getElementById('statusText').textContent = 'ƒê√£ t·∫°m d·ª´ng';
            } else {
                btn.textContent = '‚è∏Ô∏è T·∫°m D·ª´ng';
                document.getElementById('statusText').textContent = 'ƒêang nh·∫≠n di·ªán...';
            }
        }
        
        function stopLivestream() {
            livestreamActive = false;
            livestreamPaused = false;
            
            // Stop webcam
            if (livestreamStream) {
                livestreamStream.getTracks().forEach(track => track.stop());
                livestreamStream = null;
                
                const video = document.getElementById('livestreamVideo');
                video.srcObject = null;
            }
            
            // Close WebSocket
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            
            // Reset UI
            document.getElementById('startLivestreamBtn').disabled = false;
            document.getElementById('pauseLivestreamBtn').disabled = true;
            document.getElementById('stopLivestreamBtn').disabled = true;
            document.getElementById('statusText').textContent = 'ƒê√£ d·ª´ng livestream';
            document.getElementById('fpsCounter').textContent = '';
            document.getElementById('realtimeDetections').innerHTML = '';
            
            clearResults();
        }
        
        function startFrameCapture() {
            const video = document.getElementById('livestreamVideo');
            const canvas = document.getElementById('livestreamCanvas');
            const ctx = canvas.getContext('2d');
            
            function captureFrame() {
                if (!livestreamActive || !video.videoWidth) {
                    if (livestreamActive) {
                        requestAnimationFrame(captureFrame);
                    }
                    return;
                }
                
                if (!livestreamPaused) {
                    // Calculate FPS
                    const now = Date.now();
                    if (lastFrameTime > 0) {
                        const fps = Math.round(1000 / (now - lastFrameTime));
                        document.getElementById('fpsCounter').textContent = `FPS: ${fps}`;
                    }
                    lastFrameTime = now;
                    
                    // Capture frame every 200ms (5 FPS for processing)
                    if (frameCount % 3 === 0 && websocket && websocket.readyState === WebSocket.OPEN) {
                        ctx.drawImage(video, 0, 0, 640, 480);
                        const imageData = canvas.toDataURL('image/jpeg', 0.7);
                        
                        const message = JSON.stringify({
                            type: 'frame',
                            image_data: imageData,
                            fps: 15
                        });
                        
                        websocket.send(message);
                    }
                    
                    frameCount++;
                }
                
                if (livestreamActive) {
                    requestAnimationFrame(captureFrame);
                }
            }
            
            captureFrame();
        }
        
        function handleRealtimeDetection(data) {
            const detections = data.detections || [];
            const timestamp = new Date().toLocaleTimeString('vi-VN');
            
            if (detections.length > 0) {
                // Add new detection to real-time panel
                const container = document.getElementById('realtimeDetections');
                
                detections.forEach(detection => {
                    const detectionDiv = document.createElement('div');
                    detectionDiv.className = 'detection-item';
                    detectionDiv.style.marginBottom = '10px';
                    detectionDiv.style.fontSize = '0.9em';
                    
                    const vietnameseName = detection.class_name_vi || detection.class_name_en;
                    const confidence = (detection.confidence * 100).toFixed(1);
                    
                    detectionDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${vietnameseName}</strong>
                                <span class="confidence" style="margin-left: 10px;">${confidence}%</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <span style="color: #666; font-size: 0.8em; margin-right: 10px;">${timestamp}</span>
                                <button class="btn speech-btn" style="padding: 5px 10px; font-size: 0.8em;" 
                                        onclick="speakVietnamese('Ph√°t hi·ªán ${vietnameseName}')">
                                    üîä
                                </button>
                            </div>
                        </div>
                    `;
                    
                    container.insertBefore(detectionDiv, container.firstChild);
                    
                    // Speak detection automatically
                    if (document.getElementById('speechEnabled').checked) {
                        setTimeout(() => speakVietnamese(`Ph√°t hi·ªán ${vietnameseName}`), 100);
                    }
                    
                    // Keep only last 10 detections
                    while (container.children.length > 10) {
                        container.removeChild(container.lastChild);
                    }
                });
                
                // Draw bounding boxes on canvas overlay
                drawDetectionBoxes(detections);
                
                // Update stats for real-time
                updateRealtimeStats(detections);
            }
        }
        
        function drawDetectionBoxes(detections) {
            const canvas = document.getElementById('detectionCanvas');
            const ctx = canvas.getContext('2d');
            
            // Clear previous drawings
            ctx.clearRect(0, 0, 640, 480);
            
            detections.forEach(detection => {
                const [x1, y1, x2, y2] = detection.bbox;
                
                // Draw bounding box
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 3;
                ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                
                // Draw label background
                const vietnameseName = detection.class_name_vi || detection.class_name_en;
                const confidence = (detection.confidence * 100).toFixed(1);
                const label = `${vietnameseName} ${confidence}%`;
                
                ctx.fillStyle = '#00ff00';
                ctx.fillRect(x1, y1 - 25, ctx.measureText(label).width + 10, 25);
                
                // Draw label text
                ctx.fillStyle = '#000000';
                ctx.font = '14px Arial';
                ctx.fillText(label, x1 + 5, y1 - 8);
            });
        }
        
        function updateRealtimeStats(detections) {
            const avgConfidence = detections.reduce((sum, d) => sum + d.confidence, 0) / detections.length;
            
            stats.style.display = 'flex';
            document.getElementById('totalDetections').textContent = detections.length;
            document.getElementById('avgConfidence').textContent = (avgConfidence * 100).toFixed(1) + '%';
            document.getElementById('processingTime').textContent = 'Real-time';
        }
        async function startWebcam() {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                
                const video = document.getElementById('webcamVideo');
                video.srcObject = webcamStream;
                
                document.getElementById('startWebcamBtn').disabled = true;
                document.getElementById('captureBtn').disabled = false;
                document.getElementById('stopWebcamBtn').disabled = false;
                
                clearResults();
            } catch (error) {
                alert('Kh√¥ng th·ªÉ truy c·∫≠p camera: ' + error.message);
            }
        }
        
        function stopWebcam() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
                webcamStream = null;
                
                const video = document.getElementById('webcamVideo');
                video.srcObject = null;
                
                document.getElementById('startWebcamBtn').disabled = false;
                document.getElementById('captureBtn').disabled = true;
                document.getElementById('stopWebcamBtn').disabled = true;
                
                clearResults();
            }
        }
        
        function capturePhoto() {
            const video = document.getElementById('webcamVideo');
            const canvas = document.getElementById('webcamCanvas');
            const ctx = canvas.getContext('2d');
            
            // Draw video frame to canvas
            ctx.drawImage(video, 0, 0, 640, 480);
            
            // Get image data as base64
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Show preview
            preview.innerHTML = `<img id="previewImage" src="${imageData}" alt="Captured Photo">`;
            
            // Process webcam capture
            processWebcamCapture(imageData);
        }
        
        async function processWebcamCapture(imageData) {
            loading.style.display = 'block';
            results.innerHTML = '';
            stats.style.display = 'none';
            
            const startTime = performance.now();
            
            try {
                const formData = new FormData();
                formData.append('image_data', imageData);
                
                const response = await fetch('/api/webcam-capture', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                const endTime = performance.now();
                const processingTime = Math.round(endTime - startTime);
                
                if (data.success) {
                    displayResults(data, processingTime);
                } else {
                    results.innerHTML = '<div class="detection-item" style="border-left-color: #e74c3c;"><h3>L·ªói</h3><p>Kh√¥ng th·ªÉ x·ª≠ l√Ω ·∫£nh t·ª´ webcam</p></div>';
                }
            } catch (error) {
                results.innerHTML = `<div class="detection-item" style="border-left-color: #e74c3c;"><h3>L·ªói</h3><p>${error.message}</p></div>`;
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // UPLOAD AND ANALYZE
        uploadBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            loading.style.display = 'block';
            results.innerHTML = '';
            stats.style.display = 'none';
            uploadBtn.disabled = true;
            
            const startTime = performance.now();
            const endpoint = currentTab === 'video' ? '/api/detect-video' : '/api/detect';
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                const endTime = performance.now();
                const processingTime = Math.round(endTime - startTime);
                
                if (data.success) {
                    if (currentTab === 'video') {
                        displayVideoResults(data, processingTime);
                    } else {
                        displayResults(data, processingTime);
                    }
                } else {
                    results.innerHTML = '<div class="detection-item" style="border-left-color: #e74c3c;"><h3>L·ªói</h3><p>Kh√¥ng th·ªÉ x·ª≠ l√Ω file</p></div>';
                }
            } catch (error) {
                results.innerHTML = `<div class="detection-item" style="border-left-color: #e74c3c;"><h3>L·ªói</h3><p>${error.message}</p></div>`;
            } finally {
                loading.style.display = 'none';
                uploadBtn.disabled = false;
            }
        });
        
        function displayResults(data, processingTime) {
            const { num_detections, detections } = data;
            
            if (num_detections === 0) {
                results.innerHTML = '<div class="detection-item"><h3>Kh√¥ng t√¨m th·∫•y bi·ªÉn b√°o n√†o</h3></div>';
                return;
            }
            
            // Calculate stats
            const avgConf = detections.reduce((sum, d) => sum + d.confidence, 0) / num_detections;
            
            // Display stats
            stats.style.display = 'flex';
            document.getElementById('totalDetections').textContent = num_detections;
            document.getElementById('avgConfidence').textContent = (avgConf * 100).toFixed(1) + '%';
            document.getElementById('processingTime').textContent = processingTime + 'ms';
            
            // Display detections
            let html = '<h2 style="margin-bottom: 20px;">üìã K·∫øt qu·∫£ ph√°t hi·ªán:</h2>';
            
            detections.forEach((det, idx) => {
                const [x1, y1, x2, y2] = det.bbox;
                const conf = (det.confidence * 100).toFixed(1);
                const vietnameseName = det.class_name_vi || det.class_name;
                
                html += `
                    <div class="detection-item">
                        <h3>Bi·ªÉn b√°o ${idx + 1}: ${vietnameseName}</h3>
                        <span class="confidence">ƒê·ªô tin c·∫≠y: ${conf}%</span>
                        <span class="bbox">V·ªã tr√≠: [${x1}, ${y1}, ${x2}, ${y2}]</span>
                        <button class="btn speech-btn" onclick="speakVietnamese('${vietnameseName}')">
                            üîä ƒê·ªçc t√™n
                        </button>
                        ${det.note ? `<div style="margin-top: 10px; color: #666;"><em>${det.note}</em></div>` : ''}
                    </div>
                `;
                
                // Auto-speak first detection
                if (idx === 0) {
                    setTimeout(() => speakVietnamese(vietnameseName), 500);
                }
            });
            
            results.innerHTML = html;
        }
        
        function displayVideoResults(data, processingTime) {
            const { frame_detections, summary, video_info } = data;
            
            // Display video stats
            stats.style.display = 'flex';
            document.getElementById('totalDetections').textContent = summary.total_detections || 0;
            document.getElementById('avgConfidence').textContent = '85%'; // Mock average
            document.getElementById('processingTime').textContent = processingTime + 'ms';
            
            // Display video info and results
            let html = `
                <h2 style="margin-bottom: 20px;">üé¨ K·∫øt qu·∫£ ph√¢n t√≠ch video:</h2>
                <div class="detection-item">
                    <h3>üìä Th√¥ng tin video</h3>
                    <p><strong>T√™n file:</strong> ${video_info.filename}</p>
                    <p><strong>Th·ªùi l∆∞·ª£ng:</strong> ${video_info.duration_seconds} gi√¢y</p>
                    <p><strong>T·ªïng khung h√¨nh:</strong> ${video_info.total_frames}</p>
                    <p><strong>FPS:</strong> ${video_info.fps}</p>
                    <p><strong>Bi·ªÉn b√°o ph√°t hi·ªán:</strong> ${summary.detected_classes.join(', ')}</p>
                </div>
            `;
            
            // Display frame detections
            if (frame_detections.length > 0) {
                html += '<h3 style="margin: 20px 0;">‚è±Ô∏è Chi ti·∫øt theo th·ªùi gian:</h3>';
                
                frame_detections.forEach((frame, idx) => {
                    frame.detections.forEach((det, detIdx) => {
                        const vietnameseName = det.class_name_vi || det.class_name_en;
                        html += `
                            <div class="detection-item">
                                <h4>üïê ${frame.timestamp}s - ${vietnameseName}</h4>
                                <span class="confidence">ƒê·ªô tin c·∫≠y: ${(det.confidence * 100).toFixed(1)}%</span>
                                <button class="btn speech-btn" onclick="speakVietnamese('T·∫°i gi√¢y ${frame.timestamp}, ph√°t hi·ªán ${vietnameseName}')">
                                    üîä ƒê·ªçc
                                </button>
                            </div>
                        `;
                    });
                });
                
                // Auto-speak summary
                setTimeout(() => {
                    speakVietnamese(`Ph√¢n t√≠ch xong video. Ph√°t hi·ªán ${summary.total_detections} bi·ªÉn b√°o: ${summary.detected_classes.join(', ')}`);
                }, 1000);
            }
            
            results.innerHTML = html;
        }
        
        function clearResults() {
            selectedFile = null;
            preview.innerHTML = '';
            results.innerHTML = '';
            stats.style.display = 'none';
            fileInput.value = '';
            videoInput.value = '';
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'üì§ T·∫£i l√™n v√† Ph√¢n t√≠ch';
        }
        
        // Clear button
        clearBtn.addEventListener('click', clearResults);
        
        // Initialize
        window.addEventListener('beforeunload', () => {
            if (webcamStream) {
                stopWebcam();
            }
            if (livestreamActive) {
                stopLivestream();
            }
        });
    
        // Global error handling for JavaScript
        window.addEventListener('error', function(e) {
            console.warn('JavaScript Error Caught:', e.error);
            // Don't let errors break the interface
            return true;
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.warn('Promise Rejection Caught:', e.reason);
            // Don't let promise rejections break the interface
            e.preventDefault();
        });
        
        // Utility function to safely get elements
        function safeGetElement(selector) {
            try {
                return document.querySelector(selector);
            } catch (e) {
                console.warn('Element not found:', selector);
                return null;
            }
        }
        
        // Utility function for safe DOM manipulation
        function safeAppend(parent, child) {
            try {
                if (parent && child && parent.appendChild) {
                    parent.appendChild(child);
                    return true;
                }
            } catch (e) {
                console.warn('DOM append failed:', e);
            }
            return false;
        }
    </script>
</body>
</html>